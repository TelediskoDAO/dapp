<script lang="ts">
  import Button, { Label } from "@smui/button";
  import DataTable, { Body, Cell, Row } from "@smui/data-table";
  import IconButton, { Icon } from "@smui/icon-button";
  import { Svg } from "@smui/common/elements";
  import Tooltip, { Wrapper } from "@smui/tooltip";
  import { onMount } from "svelte";

  import { title } from "../../state/runtime";
  import { graphQLClient } from "../../net/graphQl";
  import { getResolutionsQuery } from "../../graphql/get-resolutions.query";

  import type { ResolutionEntityEnhanced, ResolutionState } from "../../types";
  import {
    getEnhancedResolutions,
    RESOLUTION_STATES,
  } from "../../helpers/resolutions";
  import { acl, currentTimestamp } from "../../state/resolutions";
  import CurrentTimestamp from "../../components/CurrentTimestamp.svelte";
  import ResolutionStateTag from "../../components/ResolutionStateTag.svelte";
  import Skeleton from "../../components/Skeleton.svelte";
  import Select, { Option } from "@smui/select";
  import Countdown from "../../components/Countdown.svelte";

  let resolutions: ResolutionEntityEnhanced[] = [];
  let ready = false;
  let empty = false;
  let stateFilter: ResolutionState | "all" = "all";
  let possibleFilters: Record<string, number> = { all: 0 };

  onMount(async () => {
    const {
      resolutions: resolutionsData,
    }: {
      resolutions: ResolutionEntityEnhanced[];
    } = await graphQLClient.request(getResolutionsQuery);
    resolutions = resolutionsData;
    empty = resolutions.length === 0;
    if (empty) {
      ready = true;
    }
  });

  $: {
    if (resolutions.length > 0 && $currentTimestamp && $acl) {
      resolutions = getEnhancedResolutions(
        resolutions,
        $currentTimestamp,
        $acl
      );
      possibleFilters = resolutions.reduce((filters, resolution) => {
        const filterKey = resolution.state;
        filters[filterKey] = filters[filterKey] + 1 || 1;
        return filters;
      }, {});
      ready = true;
    }
  }

  title.set("Resolutions");
</script>

<section>
  <CurrentTimestamp intervalMs={3000} />
  <div class="header">
    {#if !empty && ready && $acl?.canCreate}
      <Button variant="outlined" href="#/resolutions/new">
        <Label>Create resolution</Label>
      </Button>
    {/if}
    {#if ready && Object.keys(possibleFilters).length > 1}
      <div>
        <Select bind:value={stateFilter} label="Filter by state">
          <Option value={"all"}>all ({resolutions.length})</Option>
          {#each Object.keys(possibleFilters) as resolutionState}
            <Option value={resolutionState}>
              {resolutionState} ({possibleFilters[resolutionState]})</Option
            >
          {/each}
        </Select>
      </div>
    {/if}
  </div>
  {#if !ready}
    <Skeleton height={300} style="margin-top: 42px">
      <rect width="100%" height="67" x="0" y="0" rx="6px" ry="6px" />
      <rect width="100%" height="67" x="0" y="69" rx="6px" ry="6px" />
      <rect width="100%" height="67" x="0" y="138" rx="6px" ry="6px" />
    </Skeleton>
  {:else}
    <DataTable table$aria-label="Resolutions list" style="width: 100%;">
      <Body>
        {#each resolutions.filter((res) => stateFilter === "all" || res.state === stateFilter) as resolution}
          <Row>
            <Cell width="80%">
              <div class="resolution-info">
                <h4 class="resolution-title">{resolution.title}</h4>
                {#if resolution.state === RESOLUTION_STATES.PRE_DRAFT}
                  <small class="resolution-detail-sm"
                    ><span>Created on</span>
                    {resolution.createdAt} <b>by</b>
                    {resolution.createBy}</small
                  >
                {/if}
                {#if resolution.state === RESOLUTION_STATES.NOTICE}
                  <small class="resolution-detail-sm"
                    ><Countdown
                      targetDate={resolution.resolutionTypeInfo
                        .noticePeriodEnds}
                      prefixLabel="Voting starts"
                    /></small
                  >
                {/if}
                {#if resolution.state === RESOLUTION_STATES.VOTING}
                  <small class="resolution-detail-sm"
                    ><Countdown
                      targetDate={resolution.resolutionTypeInfo.votingEnds}
                      prefixLabel="Voting ends"
                    /></small
                  >
                {/if}
                {#if resolution.state === RESOLUTION_STATES.ENDED}
                  <small class="resolution-detail-sm"
                    ><span
                      >{resolution.hasQuorum
                        ? "Has reached quorum"
                        : "Has not reached quorum"}</span
                    >
                    and has ended on
                    {resolution.resolutionTypeInfo.votingEndsAt}
                  </small>
                {/if}
              </div>
            </Cell>
            <Cell
              ><span class="resolution-type"
                ><small>{resolution.resolutionType.name}</small></span
              ></Cell
            >
            <Cell><ResolutionStateTag label={resolution.state} /></Cell>
            <Cell>
              <Wrapper>
                <IconButton
                  class="material-icons"
                  size="button"
                  href={resolution.href}
                >
                  <Icon component={Svg} viewBox="0 0 24 24">
                    <path fill="#777" d={resolution.action.icon} />
                  </Icon>
                </IconButton>
                <Tooltip yPos="above">{resolution.action.label}</Tooltip>
              </Wrapper>
            </Cell>
          </Row>
        {/each}
      </Body>
    </DataTable>
  {/if}
  {#if empty && ready && $acl?.canCreate}
    <Button variant="outlined" href="#/resolutions/new">
      <Label>Create resolution</Label>
    </Button>
  {/if}
</section>

<style>
  .resolution-info {
    padding: 1rem 0;
  }
  .resolution-title {
    margin: 0;
    padding: 0;
  }
  .resolution-type {
    color: var(--color-gray-7);
  }
  .resolution-detail-sm {
    display: block;
    color: var(--color-gray-7);
    line-height: 15px;
  }

  .resolution-detail-sm > span {
    font-weight: bold;
  }

  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-bottom: 1rem;
  }

  .header > div {
    margin-left: auto;
  }
</style>
